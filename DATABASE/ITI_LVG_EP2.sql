CREATE DATABASE TRANSPORTE;
USE TRANSPORTE;

CREATE TABLE  CAMION(
	ID_CAM INT PRIMARY KEY,
    MODELO VARCHAR(100),
    MARCA VARCHAR(100),
    TIPO VARCHAR(100),
    ADQUISICION DATE,
    EJES INT
);
SELECT *FROM CAMION;	

CREATE TABLE  OPERADOR(
	ID_OPE INT PRIMARY KEY,
    NOMBRE VARCHAR(100),
    APELLIDO VARCHAR(100),
    NIVEL INT,
    HORAS INT
);

SELECT *FROM OPERADOR;

CREATE TABLE SERVICIO(
	ID_SER INT PRIMARY KEY auto_increment,
    ORIGEN VARCHAR(50),
    DESTINO VARCHAR(50),
    FECHA_SALIDA DATE,
    FECHA_LLEGADA DATE,
    IdCa INT,
    IdOp INT,
    FOREIGN KEY(IdCa) REFERENCES CAMION(ID_CAM),
	FOREIGN KEY(IdOp) REFERENCES OPERADOR(ID_OPE)
);

SELECT COLUMN_NAME IS_NULLABLE, DATA_TYPE,COLUMN_KEY
	FROM information_schema.COLUMNS WHERE TABLE_SCHEMA ='TRANSPORTE'and TABLE_NAME= 'SERVICIO';

INSERT INTO CAMION(ID_CAM, MODELO, MARCA, TIPO, ADQUISICION, EJES) VALUES(1, "TRACTO","MERCEDES","F", '2009/08/02', 6);
INSERT INTO CAMION(ID_CAM, MODELO, MARCA, TIPO, ADQUISICION, EJES) VALUES(2, "MEDIANO","VOLKSWAGEN","G", '2009/08/12', 4);
INSERT INTO CAMION(ID_CAM, MODELO, MARCA, TIPO, ADQUISICION, EJES) VALUES(3, "SEVERO","VOLVO","K", '2015/03/19', 3);
INSERT INTO CAMION(ID_CAM, MODELO, MARCA, TIPO, ADQUISICION, EJES) VALUES(4, "TRACTO","KENWORTH","LO", '2020/09/08', 8);
INSERT INTO CAMION(ID_CAM, MODELO, MARCA, TIPO, ADQUISICION, EJES) VALUES(5, "LIGERO","INTERNATIONAL","K", '2013/02/23', 6);
INSERT INTO CAMION(ID_CAM, MODELO, MARCA, TIPO, ADQUISICION, EJES) VALUES(6, "AUTOBUS","VOLKSWAGEN","T", '2019/01/20', 5);
SELECT *FROM CAMION;

INSERT INTO OPERADOR(ID_OPE, NOMBRE , APELLIDO, NIVEL, HORAS) VALUES(1, "LUIS","JIMENEZ", 1, 12);
INSERT INTO OPERADOR(ID_OPE, NOMBRE , APELLIDO, NIVEL, HORAS) VALUES(3, "GABRIEL","DANTES", 2, 23);
INSERT INTO OPERADOR(ID_OPE, NOMBRE , APELLIDO, NIVEL, HORAS) VALUES(4, "VALENTE","REYES", 3, 13);
INSERT INTO OPERADOR(ID_OPE, NOMBRE , APELLIDO, NIVEL, HORAS) VALUES(5, "NANDO","JIJON", 2, 2);
INSERT INTO OPERADOR(ID_OPE, NOMBRE , APELLIDO, NIVEL, HORAS) VALUES(6, "LORENZO","MARES", 3, 12);
INSERT INTO OPERADOR(ID_OPE, NOMBRE , APELLIDO, NIVEL, HORAS) VALUES(8, "DANIEL","NUNO", 1, 5);
SELECT *FROM OPERADOR;

INSERT INTO SERVICIO(ORIGEN, DESTINO, FECHA_SALIDA, FECHA_LLEGADA,IdCa, IdOp) 
	VALUES ("LA JOYA","CDMX",'2019/01/22','2019/01/22', 1,3);
INSERT INTO SERVICIO(ORIGEN, DESTINO, FECHA_SALIDA, FECHA_LLEGADA,IdCa, IdOp) 
	VALUES ("COCOYOC","CUERNAVACA",'2015/09/19','2015/09/30', 3,1);
INSERT INTO SERVICIO(ORIGEN, DESTINO, FECHA_SALIDA, FECHA_LLEGADA,IdCa, IdOp) 
	VALUES ("HIGALGO","MORELOS",'2018/10/23','2018/10/25', 4,3);
INSERT INTO SERVICIO(ORIGEN, DESTINO, FECHA_SALIDA, FECHA_LLEGADA,IdCa, IdOp) 
	VALUES ("EL PORVENIR","AHUATEPEC",'2020/11/12','2020/12/01', 6,4);
INSERT INTO SERVICIO(ORIGEN, DESTINO, FECHA_SALIDA, FECHA_LLEGADA,IdCa, IdOp) 
	VALUES ("PUENTE DE IXTLA","YAUTEPEC",'2021/12/18','2021/12/30', 6,8);
INSERT INTO SERVICIO(ORIGEN, DESTINO, FECHA_SALIDA, FECHA_LLEGADA,IdCa, IdOp) 
	VALUES ("CDMX","CHAMILPA",'2022/06/23','2022/06/29', 1,6);
SELECT *FROM SERVICIO;




    
## CREACION DE FUNCIONES
#1
DELIMITER $$
CREATE FUNCTION etiquetas_camion( mo VARCHAR(50), 
								  ma  VARCHAR(30),
                                  tip VARCHAR(30),
                                  fechA DATE,
                                  ej INT)
RETURNS VARCHAR(20)
DETERMINISTIC
BEGIN
	DECLARE A, B, C, D, E ,F ,G  VARCHAR(5);
    SET A = left(mo, 2);
    SET B = left(ma,2);
    SET C = right(tip,2);
    SET D = right (year(fechA),2);
	SET E = month(fechaA);
    SET F = day(fechaA);
	SET G = ej;
    RETURN upper(concat(A,B,C,D,E,F,G));
    
END $$
DELIMITER ;
select etiquetas_camion("TRACTO", "VOLVO", "HIBRIDO", '2022/06/18', 10) AS "SALIDA";
SELECT *FROM CAMION;

#2
CREATE FUNCTION NOMINA(NIVEL INT, HORAS INT)
RETURNS TEXT DETERMINISTIC
BEGIN
    DECLARE COSTOH INT DEFAULT 75;
    DECLARE SUELDO DOUBLE DEFAULT 0;
    DECLARE FINAL TEXT;
    DECLARE HORAS_RESTANTES INT DEFAULT 0;
    DECLARE HORAS_DOBLES INT DEFAULT 0;
    DECLARE HORAS_TRIPLES INT DEFAULT 0;

    IF NIVEL = 1 THEN SET COSTOH = 80;
        ELSEIF NIVEL = 2 THEN SET COSTOH = 100;
        ELSEIF NIVEL = 3 THEN SET COSTOH = 150;
        ELSE SET COSTOH = 75;
    end if;

    SET HORAS_RESTANTES = HORAS - 30;
    IF HORAS_RESTANTES > 0 THEN
        IF ( HORAS_RESTANTES - 6 ) > 0 THEN
            SET HORAS_TRIPLES = HORAS_DOBLES;
            SET HORAS_DOBLES = 6;
        ELSE
            SET HORAS_DOBLES = HORAS_RESTANTES;
        end if;
        SET SUELDO = SUELDO + (HORAS_DOBLES * (COSTOH * 2) );
        SET SUELDO = SUELDO + (HORAS_TRIPLES * (COSTOH * 3) );
        SET SUELDO = SUELDO + (30 * COSTOH);
    ELSE
        SET SUELDO = HORAS * COSTOH;
    end if;

    SET SUELDO = SUELDO - ( (SUELDO * 0.10) + (SUELDO * 0.05) );
    RETURN CONCAT('SUELDO: ', SUELDO, ' ', 'IMSS: ' , (SUELDO * 0.10), ' ', 'ISR: ' ,(SUELDO * 0.05));
end;


#3
DELIMITER $$
CREATE FUNCTION diferencia_de_dia( fechaSal DATE, 
								   fechaLleg DATE,
                                   fechaAdq DATE)
RETURNS INT 
DETERMINISTIC
BEGIN
	IF fechaAdq IS NULL THEN 
		RETURN DATEDIFF(fechaSal, fechaLleg);
	ELSE 
		RETURN DATEDIFF(fechaAdq, fechaLleg);
        END IF;
	RETURN 0;
	
END $$
DELIMITER ;
DROP FUNCTION diferencia_de_dia;
SELECT diferencia_de_dia(FECHA_LLEGADA, FECHA_SALIDA, NULL) FROM SERVICIO;
SELECT diferencia_de_dia('2020/02/08', '2020/02/10', NULL);


#4
CREATE FUNCTION MANTENIMIENTO_CAMION(FECHA_ADQ DATE)
RETURNS TEXT DETERMINISTIC
BEGIN
    DECLARE FECHANUEVA DATE ;
    DECLARE DIFERENCIA INT DEFAULT 0;

    IF (DAY(FECHA_ADQ) >= DAY(LAST_DAY(FECHA_ADQ))-2 ) THEN
        RETURN 'NO APLICA';
    end if;

    IF (YEAR(FECHA_ADQ) = 2021 OR YEAR(FECHA_ADQ) = 2020) THEN
        IF (MONTH(FECHA_ADQ) / 3 <= 1) THEN
            SET DIFERENCIA = ( DAY(LAST_DAY(FECHA_ADQ)) - 2 ) - DAY(FECHA_ADQ);
            SET FECHANUEVA = DATE_ADD(FECHA_ADQ, INTERVAL DIFERENCIA DAY);
        ELSEIF (MONTH(FECHA_ADQ) / 3 BETWEEN 3 AND 4) THEN
            SET DIFERENCIA = ( DAY(LAST_DAY(FECHA_ADQ)) - 7 ) - DAY(FECHA_ADQ);
            SET FECHANUEVA = DATE_ADD(FECHA_ADQ, INTERVAL DIFERENCIA DAY);
        end if;
    end if;

    RETURN CONCAT('APLICA ',  FECHANUEVA);
end;









#5
DELIMITER $$
CREATE FUNCTION vacaciones(destino VARCHAR(100), fechaSalida DATE)
RETURNS INT   
DETERMINISTIC
BEGIN
	DECLARE destino VARCHAR(100);
    DECLARE dias INT;

    
    IF destino = "PUEBLA" OR destino = "TLAXCALA" OR destino = "QUERETARO" THEN 
        IF dayofweek(fechaSalida) = 5 OR 6 THEN
			SET dias = 7;
		END IF;
	END IF;
    
    IF destino = "MORELOS" OR destino = "GUADALAJARA" OR destino = "CDMX" THEN
		 IF dayofweek(fechaSalida) = 1 OR 7 THEN
			SET dias = 9;
		END IF;
	ELSEIF  dayofweek(fechaSalida) THEN
		SET dias = 5;
	END IF;
RETURN dias;
END $$
DELIMITER ;

SELECT  vacaciones(SERVICIO.DESTINO, SERVICIO.FECHA_SALIDA), 
OPERADOR.NOMBRE,dayname(SERVICIO.FECHA_SALIDA) FROM OPERADOR 
INNER JOIN SERVICIO ON OPERADOR.ID_OPE = SERVICIO.IdOp;
